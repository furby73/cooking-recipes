{% extends "base.html" %}
{% block content %}
<div class="form-container">
    <h1>{{ action }} Recipe</h1>
    <form method="post" enctype="multipart/form-data" id="recipe-form">
        <div class="form-group">
            <label for="cover_image">Cover Image</label>
            {% if recipe and recipe.cover_image %}
            <div>
                <img src="{{ recipe.cover_image }}" alt="Current cover" style="max-height: 150px; margin: 10px 0;">
                <label>
                    <input type="checkbox" name="remove_cover_image"> Remove current image
                </label>
            </div>
            {% endif %}
            <input type="file" id="cover_image" name="cover_image" accept="image/*">
        </div>

        <p>
            <label for="title">Title</label><br>
            <input id="title" name="title" type="text" required value="{{ recipe.title if recipe else '' }}">
        </p>
        <p>
            <label for="description">Description</label><br>
            <textarea id="description" name="description" required>{{ recipe.description if recipe else '' }}</textarea>
        </p>

        <div id="steps-container">
            <label>Instructions:</label>
            {% if recipe %}
            {% for step in recipe.steps.order_by('step_number') %}
            <div class="step" data-step="{{ step.step_number }}">
                <label>Step {{ step.step_number }}</label>
                <textarea name="step-{{ step.step_number }}" required>{{ step.instruction }}</textarea>

                {% if step.image %}
                <div>
                    <img src="{{ step.image }}" alt="Step image" style="max-height: 100px; margin: 5px 0;">
                    <label>
                        <input type="checkbox" name="remove_step_image-{{ step.step_number }}"> Remove image
                    </label>
                </div>
                {% endif %}

                <label>Step Image (optional)</label>
                <input type="file" name="step-image-{{ step.step_number }}" accept="image/*">

                <button type="button" class="remove-step">Remove Step</button>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        <button type="button" id="add-step" class="btn">+ Add Step</button>

        <button type="submit" class="btn">Save</button>
    </form>
    <a href="{{ url_for('admin_recipes') }}">Back</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('steps-container');
        const addButton = document.getElementById('add-step');
        let stepCount = container.querySelectorAll('.step').length || 0;

        function addStep(stepNumber) {
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step';
            stepDiv.dataset.step = stepNumber;
            stepDiv.innerHTML = `
            <label>Step ${stepNumber}</label>
            <textarea name="step-${stepNumber}" placeholder="Instruction" required></textarea>
            <label>Step Image (optional)</label>
            <input type="file" name="step-image-${stepNumber}" accept="image/*">
            <button type="button" class="remove-step">Remove Step</button>
        `;
            container.appendChild(stepDiv);
        }

        addButton.addEventListener('click', function () {
            stepCount++;
            addStep(stepCount);
        });

        container.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-step')) {
                const stepDiv = e.target.closest('.step');
                stepDiv.remove();
                const steps = container.querySelectorAll('.step');
                steps.forEach((step, index) => {
                    const newNum = index + 1;
                    step.dataset.step = newNum;
                    step.querySelector('label').textContent = `Step ${newNum}`;
                    step.querySelector('textarea').name = `step-${newNum}`;
                    step.querySelector('input[type="file"]').name = `step-image-${newNum}`;
                });
                stepCount = steps.length;
            }
        });
    });
</script>
{% endblock %}